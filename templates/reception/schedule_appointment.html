{% extends 'reception/base.html' %}
{% load widget_tweaks %}


{% block content %}
<form id="appointmentForm" method="post">
  {% csrf_token %}
  
  <div class="form-group">
    <label for="id_patient">Patient:</label>
    {{ form.patient|add_class:"form-control" }}
  </div>
  
  <div class="form-group">
    <label for="id_therapist">Therapist:</label>
    {{ form.therapist|add_class:"form-control" }}
  </div>
  
  <div class="form-group">
    <label for="id_appointment_date">Appointment Date:</label>
    {{ form.appointment_date|add_class:"form-control" }}
    <div id="dateError" class="text-danger"></div>
  </div>
  
  <div class="form-group">
    <label for="id_time_slot">Time Slot:</label>
    {{ form.time_slot|add_class:"form-control" }}
  </div>
  
  <div class="form-group">
    <button type="submit" class="btn btn-primary">Save</button>
    <a href="{% url 'list_appointments' %}" class="btn btn-danger">Cancel</a>
  </div>
</form>
{% endblock %}
{% block additional_js %}
<script>
  // Parsing server-rendered therapists data into JavaScript object
  // Assuming you are passing therapists as JSON serialized string in context
  const therapists = JSON.parse("{{ therapists|safe }}");
  let selectedTherapistId = null;

  // DOM Content Loaded Event Listener
  document.addEventListener('DOMContentLoaded', () => {
    initTherapistDropdown();
    initDateValidation();
  });

  function initTherapistDropdown() {
    const therapistDropdown = document.querySelector('#id_therapist');
    therapistDropdown.addEventListener('change', handleTherapistChange);
  }

  function handleTherapistChange(event) {
    selectedTherapistId = event.target.value;
    fetchAvailableSlots();
  }

  function initDateValidation() {
    const appointmentDateField = document.querySelector('#id_appointment_date');
    appointmentDateField.addEventListener('change', validateDate);
  }

  function fetchAvailableSlots() {
    const appointmentDate = document.querySelector('#id_appointment_date').value;
    if (!selectedTherapistId || !appointmentDate) return;
    const url = `/get_available_slots/?therapist_id=${selectedTherapistId}&appointment_date=${appointmentDate}`;
    fetch(url)
      .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => handleSuccess(data.available_slots))
      .catch(error => {
        console.error("There was an error fetching the slots:", error);
      });
  }

  function handleSuccess(data) {
    let options = "";
    for (let slot of data) {
      const disabledStatus = slot.is_booked ? 'disabled' : '';
      const bgColor = slot.is_booked ? 'red' : 'transparent';
      options += `<option style="background-color: ${bgColor};" value="${slot.id}" ${disabledStatus}>${slot.name}</option>`;
    }
    document.querySelector('#id_time_slot').innerHTML = options;
  }

  function validateDate() {
    const selectedDate = new Date(document.querySelector('#id_appointment_date').value);
    const weekday = selectedDate.getDay();
    const workingDays = therapists.find(t => t.id === parseInt(selectedTherapistId)).working_days;

    const dateError = document.querySelector('#dateError');
    if (!workingDays.includes(weekday)) {
      dateError.textContent = "Therapist is not available on this day.";
    } else {
      dateError.textContent = "";
      fetchAvailableSlots();
    }
  }
</script>
{% endblock %}
